# create-group.py

import os
import toml
import json
import requests

# Define the filename for the configuration
config_file = "secret.toml"
json_dir = "json"
os.makedirs(json_dir, exist_ok=True)

# Function to load configuration from secret.toml
def load_config():
    if not os.path.exists(config_file):
        print(f"Error: Configuration file '{config_file}' does not exist.")
        exit()
    
    config = toml.load(config_file)
    api_key = config.get("API_KEY")
    ip_address = config.get("ip")

    if not api_key or not ip_address:
        print("Error: Missing 'API_KEY' or 'ip' in the configuration file.")
        exit()
    
    return api_key, ip_address

# Function to fetch data from a given URL and save to a file in the JSON directory
def fetch_and_save(url, filename):
    try:
        response = requests.get(url)
        response.raise_for_status()
        data = response.json()

        filepath = os.path.join(json_dir, filename)
        with open(filepath, "w") as json_file:
            json.dump(data, json_file, indent=4)
        print(f"Data saved to '{filepath}'.")
        return data

    except requests.exceptions.RequestException as e:
        print(f"Error making request to {url}: {e}")
        return None

# Function to update secret.toml with existing groups
def update_secret_with_groups(groups):
    config = toml.load(config_file)

    # Prepare groups data
    groups_dict = {}
    for group_id, group_info in groups.items():
        group_name = group_info.get('name', 'Unknown')
        groups_dict[group_name] = group_id

    # Update the config
    config['groups'] = groups_dict

    # Write back to secret.toml
    with open(config_file, 'w') as file:
        toml.dump(config, file)
    print("Updated 'secret.toml' with existing groups.")

# Function to read paired devices and list them
def list_paired_devices(devices):
    print("\nPaired Devices:")
    for device_id, device_info in devices.items():
        device_name = device_info.get('name', 'Unknown')
        print(f"ID: {device_id}, Name: {device_name}")

# Function to create a new group
def create_group(api_key, ip_address, group_name, device_ids):
    url = f"http://{ip_address}/api/{api_key}/groups"

    data = {
        "name": group_name,
        "lights": device_ids
    }

    try:
        response = requests.post(url, json=data)
        response.raise_for_status()
        result = response.json()
        print(f"API Response: {result}")
        if isinstance(result, list) and 'success' in result[0]:
            group_id = result[0]['success']['id']
            print(f"Group '{group_name}' created with ID: {group_id}")
            return group_id
        else:
            print(f"Failed to create group: {result}")
            return None
    except requests.exceptions.RequestException as e:
        print(f"Error making request to {url}: {e}")
        return None

# Function to add new group to secret.toml
def add_group_to_secret(group_id, group_name):
    config = toml.load(config_file)

    # Update the groups dictionary
    if 'groups' not in config:
        config['groups'] = {}

    config['groups'][group_name] = group_id

    # Write back to secret.toml
    with open(config_file, 'w') as file:
        toml.dump(config, file)
    print(f"Added new group '{group_name}' with ID '{group_id}' to 'secret.toml'.")

def main():
    # Load configuration
    api_key, ip_address = load_config()

    # Check if existing-groups.json and paired-devices.json exist
    existing_groups_path = os.path.join(json_dir, 'existing-groups.json')
    paired_devices_path = os.path.join(json_dir, 'paired-devices.json')

    if not os.path.exists(existing_groups_path) or not os.path.exists(paired_devices_path):
        print("Fetching latest data...")
        # Fetch data and save
        urls = {
            "existing-groups.json": f"http://{ip_address}/api/{api_key}/groups",
            "paired-devices.json": f"http://{ip_address}/api/{api_key}/lights"
        }
        for filename, url in urls.items():
            fetch_and_save(url, filename)

    # Load existing groups
    with open(existing_groups_path, 'r') as f:
        groups = json.load(f)

    # Update secret.toml with existing groups
    update_secret_with_groups(groups)

    # Load paired devices
    with open(paired_devices_path, 'r') as f:
        devices = json.load(f)

    # List paired devices
    list_paired_devices(devices)

    # Ask user for devices to add to the new group
    device_ids_input = input("\nEnter the IDs of the devices to add to the new group (comma-separated): ").split(',')

    # Clean up the device IDs and validate them
    device_ids = []
    for device_id in device_ids_input:
        device_id = device_id.strip()
        if device_id in devices:
            device_ids.append(device_id)
        else:
            print(f"Device ID '{device_id}' is not valid and will be ignored.")

    if not device_ids:
        print("No valid device IDs entered. Exiting.")
        return

    # Ask user for the name of the new group
    group_name = input("Enter the name for the new group: ").strip()
    if not group_name:
        print("Group name cannot be empty. Exiting.")
        return

    # Create the new group via API
    group_id = create_group(api_key, ip_address, group_name, device_ids)
    if group_id:
        # Add the new group to secret.toml
        add_group_to_secret(group_id, group_name)

        # Update existing-groups.json with the new group
        # Fetch the latest groups data
        url = f"http://{ip_address}/api/{api_key}/groups"
        groups = fetch_and_save(url, "existing-groups.json")
        # Update secret.toml with the updated groups
        update_secret_with_groups(groups)
    else:
        print("Failed to create the new group.")

if __name__ == "__main__":
    main()
